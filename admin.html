<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Veltra — Admin</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { background:black; color:white; font-family:sans-serif; }
    .container { max-width: 800px; margin: auto; padding:16px; }
    .panel { background:#000; color:white; padding:16px; margin:8px 0; border:1px solid #fff; border-radius:8px; }
    .input { background:#111; color:white; border:1px solid #fff; padding:8px; margin:4px 0; width:100%; }
    .btn { background:#000; color:white; border:1px solid #fff; padding:8px 12px; cursor:pointer; transition:0.2s; }
    .btn:hover { background:#222; border-color:#ccc; }
    .small { font-size:0.8em; color:#ccc; }
    .note { font-size:0.8em; color:#aaa; margin-top:4px; }
    .logo-img { width:48px; height:48px; border-radius:8px; object-fit:contain; display:block; border:1px solid white; box-shadow:0 6px 18px rgba(255,255,255,0.1); background:#000; margin-bottom:16px; }
    .form-row { margin-bottom:12px; }
    #backBtn { font-size:1em; padding:6px 10px; border-radius:6px; margin-bottom:16px; }
  </style>
</head>
<body>
<div class="container">

  <!-- Back button -->
  <button id="backBtn" class="btn">← Back</button>

  <!-- Logo -->
  <img src="https://raw.githubusercontent.com/mojhehh/Ihateschool/9c2adba6db2e99e34e55a8bf98089f45521457d5/black-and-white-geometric-logos-1%20(1).png" 
       alt="Veltra Logo" 
       class="logo-img">

  <!-- Login panel -->
  <div id="loginPanel" class="panel">
    <h2>Admin Login</h2>
    <div class="form-row">
      <input id="email" class="input" placeholder="Admin email" type="email">
      <input id="password" class="input" placeholder="Password" type="password">
      <button id="loginBtn" class="btn">Login</button>
    </div>
    <div id="loginMsg" class="note"></div>
    <div class="note">Click the lock on the main page to open this. Nothing admin loads until you log in.</div>
  </div>

  <!-- Admin panel -->
  <div id="adminUI" style="display:none;">
    <div class="panel">
      <h2>Admin Panel</h2>
      <div class="small">Add / edit / delete bookmarks and categories. Changes update in realtime.</div>
      <hr>

      <!-- Bookmarks -->
      <h3>Add / Edit Bookmark</h3>
      <div class="form-row"><input id="bTitle" class="input" placeholder="Title"><span class="small">Shown to users.</span></div>
      <div class="form-row"><input id="bUrl" class="input" placeholder="Direct URL (optional)"><span class="small">Optional. If provided, 'Open' will open this URL.</span></div>
      <div class="form-row"><input id="bCode" class="input" placeholder="One-line code/bookmarklet"><span class="small">Paste a one-liner bookmarklet or code.</span></div>
      <div class="form-row"><input id="bCats" class="input" placeholder="Categories (comma separated keys)"><span class="small">Example: tools,fun</span></div>
      <div class="form-row"><input id="bCredits" class="input" placeholder="Credits link (optional)"><span class="small">Optional: credit source or author link.</span>
        <label style="color:white;"><input id="bFeatured" type="checkbox"> Featured</label></div>
      <div class="form-row">
        <button id="saveBookmark" class="btn">Save</button>
        <button id="clearForm" class="btn">Clear</button>
      </div>

      <hr>
      <!-- Categories -->
      <h3>Categories</h3>
      <div class="form-row">
        <input id="catKey" class="input" placeholder="Category key (no spaces)">
        <input id="catName" class="input" placeholder="Category display name">
        <button id="addCat" class="btn">Add Category</button>
      </div>
      <div class="note">Category keys are used when adding bookmarks.</div>

      <hr>
      <!-- Existing bookmarks -->
      <h3>Existing Bookmarks</h3>
      <div id="adminList"></div>

      <hr>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from './firebase-config.js';
import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { ref, onValue, push, set, update, remove, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

// Elements
const loginPanel = document.getElementById('loginPanel');
const loginMsg = document.getElementById('loginMsg');
const adminUI = document.getElementById('adminUI');
const loginBtn = document.getElementById('loginBtn');
const emailEl = document.getElementById('email');
const passEl = document.getElementById('password');
const logoutBtn = document.getElementById('logoutBtn');
const backBtn = document.getElementById('backBtn');

const bTitle = document.getElementById('bTitle');
const bUrl = document.getElementById('bUrl');
const bCode = document.getElementById('bCode');
const bCats = document.getElementById('bCats');
const bCredits = document.getElementById('bCredits');
const bFeatured = document.getElementById('bFeatured');
const saveBookmark = document.getElementById('saveBookmark');
const clearForm = document.getElementById('clearForm');
const adminList = document.getElementById('adminList');

const catKey = document.getElementById('catKey');
const catName = document.getElementById('catName');
const addCat = document.getElementById('addCat');

let editingId = null;
let bookmarksCache = {};
let categoriesCache = {};

// Back button
backBtn.addEventListener('click', () => {
  window.location.href = 'index.html'; // change this to your main page URL
});

// Login
loginBtn.addEventListener('click', async () => {
  loginMsg.textContent = '';
  try {
    const cred = await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
    const uid = cred.user.uid;
    const snap = await get(ref(db, `admins/${uid}`));
    if(!snap.exists()){
      await signOut(auth);
      loginMsg.textContent = 'Not an admin.';
      return;
    }
    loginPanel.style.display = 'none';
    adminUI.style.display = 'block';
  } catch(err){
    loginMsg.textContent = 'Login failed: ' + err.message;
  }
});

// Auth state
onAuthStateChanged(auth, async (user) => {
  if(user){
    const uid = user.uid;
    const snap = await get(ref(db, `admins/${uid}`));
    if(snap.exists()){
      loginPanel.style.display = 'none';
      adminUI.style.display = 'block';
    } else {
      await signOut(auth).catch(()=>{});
      loginPanel.style.display = 'block';
      adminUI.style.display = 'none';
    }
  } else {
    loginPanel.style.display = 'block';
    adminUI.style.display = 'none';
  }
});

// Logout
logoutBtn.addEventListener('click', async () => {
  await signOut(auth);
  loginPanel.style.display = 'block';
  adminUI.style.display = 'none';
});

// Live watches
const bRef = ref(db, 'bookmarks');
onValue(bRef, snap => {
  bookmarksCache = snap.val() || {};
  renderAdminList();
});
const cRef = ref(db, 'categories');
onValue(cRef, snap => {
  categoriesCache = snap.val() || {};
  renderAdminList();
});

// Render bookmarks
function renderAdminList(){
  adminList.innerHTML = '';
  const entries = Object.entries(bookmarksCache).sort((a,b)=> (b[1].createdAt||0) - (a[1].createdAt||0));
  if(entries.length===0){ adminList.innerHTML='<div class="small">No bookmarks yet.</div>'; return; }
  entries.forEach(([id,item])=>{
    const div = document.createElement('div');
    div.className = 'panel';
    div.style.marginBottom='8px';
    const cats = (item.categories||[]).toString();
    div.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-weight:600;">${escapeHtml(item.title||'Untitled')}</div>
          <div class="small">${escapeHtml(item.desc||'')}</div>
          <div class="small">Cats: ${escapeHtml(cats)}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <button class="btn edit" data-id="${id}">Edit</button>
          <button class="btn delete" data-id="${id}">Delete</button>
        </div>
      </div>`;
    adminList.appendChild(div);
  });

  adminList.querySelectorAll('.edit').forEach(btn=>btn.addEventListener('click',()=>startEdit(btn.dataset.id)));
  adminList.querySelectorAll('.delete').forEach(btn=>btn.addEventListener('click',async ()=>{
    const id = btn.dataset.id;
    if(confirm('Delete this bookmark? This cannot be undone.')) await remove(ref(db, `bookmarks/${id}`));
  }));
}

// Edit bookmark
function startEdit(id){
  const b = bookmarksCache[id]; if(!b) return;
  editingId=id;
  bTitle.value=b.title||'';
  bUrl.value=b.url||'';
  bCode.value=b.code||'';
  bCats.value=(b.categories||[]).join(',');
  bCredits.value=b.creditsLink||'';
  bFeatured.checked=!!b.featured;
  window.scrollTo({top:0,behavior:'smooth'});
}

// Save bookmark
saveBookmark.addEventListener('click', async ()=>{
  const title=bTitle.value.trim(), url=bUrl.value.trim(), code=bCode.value.trim();
  const categoriesArr=(bCats.value.trim()||'').split(',').map(s=>s.trim()).filter(Boolean);
  const credits=bCredits.value.trim(), featured=bFeatured.checked;
  if(!title||(!url&&!code)){ alert('Title + URL/code required'); return; }
  if(code.split(/\r\n|\r|\n/).length>1){ alert('Bookmarklet/code must be one line'); return; }

  const payload = { title, desc:'', url, code, categories:categoriesArr, creditsLink:credits, featured, popularity:editingId?(bookmarksCache[editingId]?.popularity||0):0, createdAt:editingId?(bookmarksCache[editingId]?.createdAt||Date.now()):Date.now() };
  if(editingId){ await update(ref(db, `bookmarks/${editingId}`), payload); editingId=null; } 
  else{ const newRef=push(ref(db, 'bookmarks')); await set(newRef, payload); }
  bTitle.value=bUrl.value=bCode.value=bCats.value=bCredits.value=''; bFeatured.checked=false;
});

// Clear form
clearForm.addEventListener('click', ()=>{ editingId=null; bTitle.value=bUrl.value=bCode.value=bCats.value=bCredits.value=''; bFeatured.checked=false; });

// Add category
addCat.addEventListener('click', async ()=>{
  const key=(catKey.value||'').trim(), name=(catName.value||'').trim();
  if(!key||!name){ alert('Both key and name required'); return; }
  await set(ref(db, `categories/${key}`), {name, createdAt:Date.now()});
  catKey.value=''; catName.value=''; alert('Category added');
});

// Helper
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
</script>
</body>
</html>

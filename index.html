<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Veltra</title>
<style>
:root{
  --bg:#000; --text:#fff; --muted:rgba(255,255,255,0.65);
  --border:rgba(255,255,255,0.12); --glow:rgba(255,255,255,0.12);
  --card-bg:rgba(255,255,255,0.02);
}
html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,sans-serif;}
a{color:var(--text);text-decoration:underline;}
.container{max-width:1100px;margin:18px auto;padding:14px;}
.header{display:flex;align-items:center;gap:12px;padding:8px 0;position:relative;z-index:2;}
.logo{width:48px;height:48px;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;}
.logo img{width:100%;height:100%;object-fit:contain;}
.title{font-size:20px;font-weight:600;}
.tag{color:var(--muted);font-size:13px;margin-top:2px;}
.controls{margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.search,.select,.btn{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;}
.search::placeholder{color:var(--muted);}
.search:focus,.select:focus,.btn:focus{outline:none;box-shadow:0 0 8px var(--glow);}
.top-controls{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap;}
.filter-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.small{font-size:13px;color:var(--muted);}
.cat-chips{display:flex;gap:8px;flex-wrap:wrap;}
.cat-chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);cursor:pointer;background:transparent;color:var(--text);font-size:13px;}
.cat-chip.selected{box-shadow:0 0 8px var(--glow);transform:translateY(-2px);}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-top:14px;}
.card{border:1px solid var(--border);padding:12px;border-radius:10px;background:var(--card-bg);transition: transform .18s ease, box-shadow .18s ease;}
.card:hover{transform: translateY(-6px) scale(1.01);box-shadow:0 10px 30px var(--glow);}
.card-head{display:flex;justify-content:space-between;align-items:center;gap:8px;}
.titleSmall{font-weight:600;}
.catTag{font-size:12px;padding:6px;border-radius:8px;border:1px solid var(--border);color:var(--text);background:transparent;}
.desc{color:var(--muted);font-size:13px;margin:8px 0;min-height:38px;}
.actions{display:flex;gap:8px;align-items:center;}
.copy-square{width:44px;height:44px;border-radius:8px;border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;background:transparent;color:var(--text);font-weight:700;font-size:20px;}
.copy-square img{width:24px;height:24px;}
.copy-square:hover{box-shadow:0 0 10px var(--glow);transform:translateY(-2px);}
.toast{position:fixed;left:50%;transform:translateX(-50%);top:14px;padding:12px 18px;border-radius:999px;background:#000;color:#fff;box-shadow:0 10px 30px rgba(255,255,255,0.12);z-index:999;opacity:0;pointer-events:none;transition:opacity 0.3s;}
.toast.show{opacity:1;}
.toast .link{color:#fff;text-decoration:underline;font-weight:700;}
#lockBtn{position:fixed;top:16px;right:16px;width:40px;height:40px;border-radius:8px;padding:6px;border:1px solid var(--border);background:transparent;cursor:pointer;opacity:0.8;z-index:1000;transition:transform 0.2s,opacity 0.2s;}
#lockBtn img{width:100%;height:100%;display:block;}
#lockBtn:hover{transform:scale(1.2);opacity:1;}
#instructionsOverlay{
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.95); color:#fff;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  z-index:2000; padding:40px; overflow:auto;
  opacity:0; pointer-events:none; transition:opacity 0.3s ease;
}
#instructionsOverlay.show { opacity:1; pointer-events:auto; }
#instructionsOverlay .content{max-width:800px; text-align:left; font-size:18px; }
#instructionsOverlay .backBtn{margin-top:20px;padding:10px 16px;font-size:16px;border:1px solid var(--border);background:transparent;color:#fff;border-radius:8px;cursor:pointer;}
.placeholder{text-align:center;padding:40px;color:var(--muted);grid-column:1/-1;border-radius:12px;border:1px solid rgba(255,255,255,0.02);}

/* TOS modal */
.tos-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 3000; transition: opacity 0.4s ease; pointer-events: auto; }
.tos-overlay.hidden { opacity:0; pointer-events:none; }
.tos-content { max-width:820px; width:92%; max-height:84%; overflow-y:auto; background: rgba(0,0,0,0.95); border:1px solid rgba(255,255,255,0.06); padding:28px; border-radius:12px; box-shadow:0 16px 36px rgba(0,0,0,0.5); font-size:16px; line-height:1.5; transition: transform 0.3s ease, box-shadow 0.3s ease; }
.tos-content .row {display:flex;align-items:center;gap:12px;}
.tos-accept { display:block; margin:18px auto 0; padding:12px 22px; font-size:16px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer; box-shadow:0 0 8px var(--glow); transition: transform .18s, box-shadow .18s; }
.tos-accept:hover { transform: translateY(-2px); box-shadow: 0 0 14px var(--glow); }

/* logo glow */
@keyframes logoGlow {
  0% { box-shadow: 0 0 4px rgba(255,255,255,0.1); }
  50% { box-shadow: 0 0 14px rgba(255,255,255,0.25); }
  100% { box-shadow: 0 0 4px rgba(255,255,255,0.1); }
}
.tos-logo-glow { animation: logoGlow 2.5s infinite ease-in-out; }

.glow-header { text-shadow: 0 0 4px rgba(255,255,255,0.18); transition: text-shadow .25s ease-in-out; }

/* responsive tweaks */
@media (max-width:1024px){
  .grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;}
  .controls{flex-direction:column;gap:8px;align-items:stretch;}
  .search{min-width:100%;}
  .copy-square{width:60px;height:60px;font-size:24px;}
  .tos-content { padding:18px; }
}
</style>
</head>
<body>

<!-- TOS overlay -->
<div id="tosOverlay" class="tos-overlay" role="dialog" aria-modal="true">
  <div class="tos-content">
    <div class="tos-header" style="text-align:center;margin-bottom:12px;">
      <div style="display:flex;align-items:center;justify-content:center;gap:12px;">
        <div style="width:56px;height:56px;border-radius:10px;overflow:hidden;">
          <img id="tosHeaderLogoSmall" src="https://raw.githubusercontent.com/mojhehh/Ihateschool/77582cdf6ca35abff9636d884eadb3112e5c5269/black-and-white-geometric-logos-1%20(1).png" alt="logo" style="width:100%;height:100%;object-fit:contain;">
        </div>
        <h2 class="glow-header" style="margin:0">Veltra ‚Äî Terms of Service & Privacy Policy</h2>
      </div>
      <p style="color:var(--muted);margin-top:8px"><strong>Last updated: October 28, 2025</strong></p>
    </div>

    <p>Welcome to Veltra (‚Äúwe,‚Äù ‚Äúour,‚Äù or ‚Äúus‚Äù). By using this site you agree to these Terms and our Privacy Policy. Read them and accept to continue.</p>

    <h3 class="glow-header">Terms of Service</h3>
    <ol>
      <li><strong>Educational Use Only</strong><br>All content is provided for educational purposes only.</li>
      <li><strong>No Responsibility</strong><br>Veltra is not responsible for how you use the content.</li>
      <li><strong>Redistribution Notice</strong><br>Some content comes from other sources; respect creators' rights.</li>
      <li><strong>User Responsibilities</strong><br>Follow laws and be respectful to others.</li>
      <li><strong>No Warranty</strong><br>The site is provided "as-is".</li>
      <li><strong>Links</strong><br>We aren't liable for external sites.</li>
    </ol>

    <h3 class="glow-header">Privacy Policy</h3>
    <ol>
      <li><strong>What We Collect</strong><br>We do not directly collect personal info via this site; check external services.</li>
      <li><strong>Cookies & Analytics</strong><br>We may use these for site functionality and basic traffic understanding.</li>
    </ol>

    <div style="text-align:center;margin-top:14px">
      <button id="acceptTOS" class="tos-accept" aria-label="Accept terms">I Accept</button>
    </div>
  </div>
</div>

<!-- TOS floating logo (starts hidden or centered; script controls final position) -->
<img id="tosLogo" src="https://raw.githubusercontent.com/mojhehh/Ihateschool/77582cdf6ca35abff9636d884eadb3112e5c5269/black-and-white-geometric-logos-1%20(1).png"
     alt="Veltra Logo"
     style="position:fixed;width:88px;height:88px;border-radius:12px;object-fit:contain;z-index:3500;display:none;pointer-events:none;">

<!-- Main container (hidden while TOS active) -->
<div class="container" id="appContent" aria-hidden="true">
  <div class="header">
    <div class="logo"><img id="headerLogoImg" src="https://raw.githubusercontent.com/mojhehh/Ihateschool/77582cdf6ca35abff9636d884eadb3112e5c5269/black-and-white-geometric-logos-1%20(1).png" alt="Veltra Logo"></div>
    <div>
      <div class="title">Veltra</div>
      <div class="tag">Bookmarks & bookmarklets ‚Äî clean & quick</div>
    </div>
    <div class="controls" aria-hidden="false">
      <input id="search" class="search" placeholder="Search... (press Enter)">
      <select id="sortSelect" class="select" title="Sort">
        <option value="newest">Newest</option>
        <option value="popular">Most popular</option>
        <option value="alpha">Alphabetical</option>
      </select>
      <button id="instructionsBtn" class="btn">Instructions</button>
    </div>
  </div>

  <div class="top-controls">
    <div class="filter-row">
      <div class="small">Filter categories:</div>
      <div id="catChips" class="cat-chips"></div>
    </div>
    <div class="controls-row">
      <div class="small">Selected: <span id="activeCount">All</span></div>
      <button id="clearCats" class="btn">Clear</button>
    </div>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>
  <div id="placeholder" class="placeholder" style="display:none">No bookmarks match. Try another filter.</div>
</div>

<button id="lockBtn" title="Admin">
  <img src="https://raw.githubusercontent.com/mojhehh/Ihateschool/4aca40ab959224fb756c3d04fe34f266d635f477/lock-icon-clipart-free-png%20(1).webp" alt="Admin Lock">
</button>

<div id="toast" class="toast" role="status" aria-live="polite"><span id="toastText"></span></div>

<!-- Instructions overlay (kept simple) -->
<div id="instructionsOverlay">
  <div class="content">
    <h2>Instructions</h2>
    <p>Click the clipboard icon on any card to copy the bookmarklet code. Use the filter chips and search to find items fast.</p>
  </div>
  <button class="backBtn" id="closeInstructions">Back</button>
</div>

<script type="module">
// ----- Firebase imports (keep these lines if you use firebase-config.js) -----
import { db } from './firebase-config.js';
import { ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
// ---------------------------------------------------------------------------

// UI nodes
const tosOverlay = document.getElementById('tosOverlay');
const acceptTOS = document.getElementById('acceptTOS');
const tosLogo = document.getElementById('tosLogo');
const headerLogoImg = document.getElementById('headerLogoImg');
const appContent = document.getElementById('appContent');
const grid = document.getElementById('grid');
const placeholder = document.getElementById('placeholder');
const toast = document.getElementById('toast');
const toastText = document.getElementById('toastText');
const searchInput = document.getElementById('search');
const sortSelect = document.getElementById('sortSelect');
const catChips = document.getElementById('catChips');
const clearCats = document.getElementById('clearCats');
const activeCount = document.getElementById('activeCount');
const instructionsBtn = document.getElementById('instructionsBtn');
const instructionsOverlay = document.getElementById('instructionsOverlay');
const closeInstructions = document.getElementById('closeInstructions');

let bookmarks = {};    // will hold bookmark objects from firebase
let categories = {};   // will hold categories from firebase
let selectedCats = new Set();
let lastSearchTerm = '';
let currentSort = sortSelect.value || 'newest';

// Defensive helpers: safeLower returns '' for undefined/null
const safeLower = (v) => (v === undefined || v === null) ? '' : String(v).toLowerCase();

// Show short toast
function showToast(msg){
  toastText.textContent = msg;
  toast.classList.add('show');
  setTimeout(()=> toast.classList.remove('show'),1500);
}

// ---------------- TOS logic & animation ----------------
const accepted = localStorage.getItem('veltraTOSAccepted') === 'true';

// Center tosLogo when overlay active, hide when not active.
// The animation will translate+scale tosLogo to the header's center and then hide the overlay.
function placeTosLogoAtCenter(){
  // show and center
  tosLogo.style.display = 'block';
  tosLogo.style.position = 'fixed';
  tosLogo.style.transform = 'translate(-50%,-50%)';
  tosLogo.style.left = '50%';
  tosLogo.style.top = '50%';
  tosLogo.style.width = '88px';
  tosLogo.style.height = '88px';
  tosLogo.classList.remove('tos-logo-glow');
}

function placeLogoIntoHeaderInstant(){
  // place header logo visible and hide tosLogo
  tosLogo.style.display = 'none';
  headerLogoImg.style.visibility = 'visible';
}

function showTOSOverlay(show){
  if(show){
    tosOverlay.style.display = 'flex';
    tosOverlay.classList.remove('hidden');
    placeTosLogoAtCenter();
    document.body.style.overflow = 'hidden';
    appContent.setAttribute('aria-hidden','true');
    headerLogoImg.style.visibility = 'hidden';
  } else {
    tosOverlay.classList.add('hidden');
    // let CSS transition run if any then hide overlay
    setTimeout(()=> tosOverlay.style.display = 'none', 380);
    document.body.style.overflow = '';
    appContent.setAttribute('aria-hidden','false');
  }
}

// if accepted already, skip overlay and show header logo
if(accepted){
  showTOSOverlay(false);
  placeLogoIntoHeaderInstant();
  appContent.removeAttribute('aria-hidden');
} else {
  showTOSOverlay(true);
}

// When user accepts: animate tosLogo -> header, then finalize
acceptTOS.addEventListener('click', () => {
  localStorage.setItem('veltraTOSAccepted','true');

  // Ensure both images are measured
  headerLogoImg.style.visibility = 'hidden'; // hide header copy during animation
  placeTosLogoAtCenter();

  // compute transform from tosLogo center to headerLogo center
  const headerRect = headerLogoImg.getBoundingClientRect();
  const tosRect = tosLogo.getBoundingClientRect();
  const tosCenterX = tosRect.left + tosRect.width/2;
  const tosCenterY = tosRect.top + tosRect.height/2;
  const headerCenterX = headerRect.left + headerRect.width/2;
  const headerCenterY = headerRect.top + headerRect.height/2;
  const deltaX = headerCenterX - tosCenterX;
  const deltaY = headerCenterY - tosCenterY;
  const scale = Math.min(headerRect.width / tosRect.width, headerRect.height / tosRect.height) || 1;

  // apply transform (translate + scale)
  tosLogo.style.transition = 'transform 0.75s cubic-bezier(0.4,0,0.2,1), width 0.2s, height 0.2s';
  tosLogo.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scale})`;
  // optional small scale pop
  setTimeout(()=> {
    tosLogo.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scale*0.98})`;
  }, 650);

  // after animation ends, finalize: hide tos overlay and show header logo image
  tosLogo.addEventListener('transitionend', function done(){
    tosLogo.removeEventListener('transitionend', done);
    // hide floating logo and reveal header logo
    tosLogo.style.display = 'none';
    headerLogoImg.style.visibility = 'visible';
    showTOSOverlay(false);
  }, {once: true});
});

// --------------- Firebase listeners & rendering ----------------
// categories is expected as {catId: {name: '...'}} or {catId: 'Name'}
// bookmarks expected as {id: {title, desc, code, categories: ['catId'], created, popularity}}
onValue(ref(db, 'categories'), snap => {
  categories = snap.val() || {};
  renderCategoryChips();
  renderGrid(); // re-render in case names changed
});

onValue(ref(db, 'bookmarks'), snap => {
  bookmarks = snap.val() || {};
  renderGrid();
});

// Render category chips
function renderCategoryChips(){
  catChips.innerHTML = '';
  const keys = Object.keys(categories || {});
  if(keys.length === 0){
    catChips.innerHTML = '<div class="small">No categories yet</div>';
    return;
  }
  keys.sort((a,b) => {
    const na = (categories[a]?.name || categories[a] || a).toString().toLowerCase();
    const nb = (categories[b]?.name || categories[b] || b).toString().toLowerCase();
    return na.localeCompare(nb);
  }).forEach(k => {
    const name = (categories[k]?.name || categories[k] || k).toString();
    const btn = document.createElement('button');
    btn.className = 'cat-chip';
    btn.textContent = name;
    btn.dataset.key = k;
    btn.addEventListener('click', () => {
      if(selectedCats.has(k)) selectedCats.delete(k);
      else selectedCats.add(k);
      btn.classList.toggle('selected', selectedCats.has(k));
      renderGrid();
    });
    catChips.appendChild(btn);
  });
  updateSelectedUI();
}

function updateSelectedUI(){
  activeCount.textContent = selectedCats.size > 0 ? `${selectedCats.size} selected` : 'All';
}

// Render the bookmark grid with safe checks
function renderGrid(){
  grid.innerHTML = '';
  const term = safeLower(lastSearchTerm || '');

  // convert bookmarks object into array
  const entries = Object.entries(bookmarks || {});
  // filter with safe checks
  let arr = entries.filter(([id, item]) => {
    if(!item) return false;
    // category match
    if(selectedCats.size > 0) {
      const itemCats = Array.isArray(item.categories) ? item.categories : (item.categories ? [item.categories] : []);
      const hasCat = itemCats.some(c => selectedCats.has(c));
      if(!hasCat) return false;
    }
    // search match
    if(term) {
      const tTitle = safeLower(item.title || item.name || item.titleName || '');
      const tDesc = safeLower(item.desc || item.description || item.summary || '');
      if(!(tTitle.includes(term) || tDesc.includes(term))) return false;
    }
    return true;
  });

  // sort
  if(currentSort === 'alpha') {
    arr.sort((a,b) => ( (a[1].title || a[1].name || '') .toString().localeCompare((b[1].title || b[1].name || '') .toString()) ));
  } else if(currentSort === 'newest') {
    arr.sort((a,b) => ( (b[1].created || b[1].timestamp || 0) - (a[1].created || a[1].timestamp || 0) ));
  } else if(currentSort === 'popular') {
    arr.sort((a,b) => ( (b[1].popularity || b[1].uses || 0) - (a[1].popularity || a[1].uses || 0) ));
  }

  if(arr.length === 0){
    placeholder.style.display = 'block';
  } else {
    placeholder.style.display = 'none';
  }

  arr.forEach(([id, v]) => {
    const title = v.title || v.name || v.titleName || 'Untitled';
    const desc = v.desc || v.description || v.summary || '';
    // categories string
    const catList = Array.isArray(v.categories) ? v.categories : (v.categories ? [v.categories] : []);
    const catNames = catList.map(c => (categories[c]?.name || categories[c] || c)).filter(Boolean).join(', ');

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-head">
        <div class="titleSmall">${escapeHtml(title)}</div>
        <div class="catTag">${escapeHtml(catNames)}</div>
      </div>
      <div class="desc">${escapeHtml(desc)}</div>
      <div class="actions">
        <div class="copy-square" title="Copy bookmarklet" role="button" aria-label="Copy">
          üìã
        </div>
      </div>
    `;
    const copyBtn = card.querySelector('.copy-square');
    copyBtn.addEventListener('click', async () => {
      try {
        const code = v.code || v.bookmarklet || v.payload || '';
        await navigator.clipboard.writeText(code);
        showToast('Copied to clipboard');
        // increment clicks/popularity if you want (transaction)
        if(id && typeof id === 'string') {
          runTransaction(ref(db, `bookmarks/${id}/popularity`), c => (c || 0) + 1).catch(()=>{/* ignore */});
        }
      } catch(e) {
        showToast('Copy failed');
      }
    });
    grid.appendChild(card);
  });

  // update active count text
  activeCount.textContent = selectedCats.size > 0 ? `${selectedCats.size} selected` : (arr.length ? `${arr.length} items` : 'All');
}

// small helper to avoid XSS in inserted text (we only insert small safe strings)
function escapeHtml(str){
  if(str === undefined || str === null) return '';
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}

// UI events
searchInput.addEventListener('keydown', e => { if(e.key === 'Enter'){ lastSearchTerm = searchInput.value.trim(); renderGrid(); }});
sortSelect.addEventListener('change', () => { currentSort = sortSelect.value; renderGrid(); });
clearCats.addEventListener('click', () => { selectedCats.clear(); document.querySelectorAll('.cat-chip.selected').forEach(el => el.classList.remove('selected')); renderGrid(); });
instructionsBtn.addEventListener('click', ()=> { instructionsOverlay.classList.add('show'); });
closeInstructions.addEventListener('click', ()=> { instructionsOverlay.classList.remove('show'); });

// initial render (if firebase hasn't returned yet it'll render empty)
renderCategoryChips();
renderGrid();

</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Veltra</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Toast styling */
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: 14px;
      padding: 12px 18px;
      border-radius: 999px;
      background: #000;
      color: #fff;
      box-shadow: 0 10px 30px rgba(255,255,255,0.12);
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .toast.show { opacity: 1; }
    .toast .link {
      color: #fff;
      text-decoration: underline;
      font-weight: 700;
      transition: text-shadow 0.2s ease;
    }
    .toast .link:hover { text-shadow: 0 0 8px rgba(255,255,255,0.3); }

    /* Copy button styling */
    .copy-square {
      width: 42px;
      height: 42px;
      font-size: 20px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border,#aaa);
      cursor: pointer;
      background: #111;
      color: #fff;
      font-weight: 700;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
    }
    .copy-square:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 0 8px rgba(255,255,255,0.3);
      background: #222;
    }

    /* Lock button styling */
    #lockBtn {
      position: fixed;
      top: 16px;
      right: -50px;
      width: 36px;
      height: 36px;
      padding: 0;
      border: none;
      background: transparent;
      cursor: pointer;
      z-index: 1000;
      opacity: 0.3;
      transition: right 0.3s ease, opacity 0.3s ease, transform 0.2s ease;
    }
    #lockBtn img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    #lockBtn:hover {
      transform: scale(1.2);
      opacity: 1;
    }
    /* Slide in when top-controls hovered */
    .top-controls:hover + #lockBtn,
    .top-controls:hover ~ #lockBtn {
      right: 16px;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">V</div>
      <div>
        <div class="title">Veltra</div>
        <div class="tag">Bookmarks & bookmarklets â€” clean & quick</div>
      </div>
      <div class="controls">
        <input id="search" class="search" placeholder="Search... (press Enter to apply)">
        <select id="sortSelect" class="select" title="Sort">
          <option value="newest">Newest</option>
          <option value="popular">Most popular</option>
          <option value="alpha">Alphabetical</option>
        </select>
        <button id="instructionsBtn" class="btn">Instructions</button>
      </div>
    </div>

    <div class="top-controls">
      <div class="filter-row">
        <div class="small">Filter categories:</div>
        <div id="catChips" class="cat-chips"></div>
      </div>
      <div class="controls-row">
        <div class="small">Selected: <span id="activeCount">All</span></div>
        <button id="clearCats" class="btn">Clear</button>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="placeholder" class="placeholder" style="display:none;">No bookmarks match. Try another filter.</div>
  </div>

  <!-- Lock button -->
  <button id="lockBtn">
    <img src="https://raw.githubusercontent.com/mojhehh/Ihateschool/4aca40ab959224fb756c3d04fe34f266d635f477/lock-icon-clipart-free-png%20(1).webp" 
         alt="Admin Lock">
  </button>

  <div id="toast" class="toast"><span id="toastText"></span></div>

  <script type="module">
    import { db } from './firebase-config.js';
    import { ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const grid = document.getElementById('grid');
    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toastText');
    const searchInput = document.getElementById('search');
    const sortSelect = document.getElementById('sortSelect');
    const catChips = document.getElementById('catChips');
    const clearCats = document.getElementById('clearCats');
    const activeCount = document.getElementById('activeCount');
    const instructionsBtn = document.getElementById('instructionsBtn');
    const lockBtn = document.getElementById('lockBtn');

    lockBtn.addEventListener('click', ()=> location.href = 'admin.html');
    instructionsBtn.addEventListener('click', ()=> location.href = 'instructions.html');

    let bookmarks = {}, categories = {}, selectedCats = new Set();
    let currentSort = sortSelect.value, lastSearchTerm = '';

    const catsRef = ref(db, 'categories');
    onValue(catsRef, snap => {
      categories = snap.val() || {};
      renderCategoryChips();
    });

    const bmRef = ref(db, 'bookmarks');
    onValue(bmRef, snap => {
      bookmarks = snap.val() || {};
      renderGrid();
    });

    function renderCategoryChips(){
      catChips.innerHTML = '';
      const keys = Object.keys(categories).sort();
      if(keys.length === 0){
        catChips.innerHTML = '<div class="small">No categories yet</div>';
        return;
      }
      keys.forEach(k => {
        const name = categories[k].name || k;
        const btn = document.createElement('button');
        btn.className = 'cat-chip';
        btn.textContent = name;
        btn.dataset.key = k;
        btn.addEventListener('click', ()=> {
          const key = btn.dataset.key;
          if(selectedCats.has(key)) selectedCats.delete(key); else selectedCats.add(key);
          updateSelectedUI();
          renderGrid();
        });
        catChips.appendChild(btn);
      });
      updateSelectedUI();
    }

    function updateSelectedUI(){
      const chips = Array.from(catChips.querySelectorAll('.cat-chip'));
      chips.forEach(chip => {
        const key = chip.dataset.key;
        chip.classList.toggle('selected', selectedCats.has(key));
      });
      activeCount.textContent = selectedCats.size > 0 ? selectedCats.size + ' selected' : 'All';
    }

    clearCats.addEventListener('click', ()=> {
      selectedCats.clear();
      updateSelectedUI();
      renderGrid();
    });

    searchInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        lastSearchTerm = searchInput.value.trim().toLowerCase();
        renderGrid();
      }
    });

    sortSelect.addEventListener('change', ()=> {
      currentSort = sortSelect.value;
      renderGrid();
    });

    function renderGrid(){
      grid.innerHTML = '';
      const arr = Object.entries(bookmarks).map(([id,b]) => {
        const item = {...b, _id:id};
        if(!item.categories){
          item.categories = item.category ? (Array.isArray(item.category)? item.category : [item.category]) : [];
        }
        return item;
      });

      let filtered = arr.filter(b => {
        if(selectedCats.size>0){
          const bkCats = (b.categories||[]).map(String);
          if(!Array.from(selectedCats).some(s=>bkCats.includes(s))) return false;
        }
        if(lastSearchTerm){
          const text = ((b.title||'')+' '+(b.desc||'')+' '+(b.categories||[]).join(' ')).toLowerCase();
          return text.includes(lastSearchTerm);
        }
        return true;
      });

      if(currentSort==='popular') filtered.sort((a,b)=> (b.popularity||0)-(a.popularity||0));
      else if(currentSort==='alpha') filtered.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
      else filtered.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

      if(filtered.length===0){ document.getElementById('placeholder').style.display='block'; return; }
      else document.getElementById('placeholder').style.display='none';

      filtered.forEach(b=>{
        const card = document.createElement('div');
        card.className='card';
        const catNames = (b.categories||[]).map(k=> categories[k]?categories[k].name:k).filter(Boolean);
        card.innerHTML=`
          <div class="card-head">
            <div class="titleSmall">${escapeHtml(b.title||'Untitled')}</div>
            <div class="catTag">${escapeHtml(catNames.join(', ')||'General')}</div>
          </div>
          <div class="desc">${escapeHtml(b.desc||'')}</div>
          <div class="actions">
            <button class="copy-square" title="Copy">ðŸ“‹</button>
            ${b.creditsLink? `<a class="small" target="_blank" href="${escapeHtml(b.creditsLink)}">Credits</a>`: ''}
          </div>
        `;
        const copyBtn = card.querySelector('.copy-square');
        copyBtn.addEventListener('click', async ()=>{
          try{
            await navigator.clipboard.writeText(b.code||b.url||'');
            showToast('âœ… Copied! Visit <a href="instructions.html" class="link" target="_blank">instructions</a> to install the bookmark.');
            const pRef = ref(db, `bookmarks/${b._id}/popularity`);
            runTransaction(pRef, curr => (curr||0)+1);
          } catch(err){ showToast('âœ– Copy failed â€” select and copy manually.'); }
        });
        grid.appendChild(card);
      });
    }

    function showToast(html){
      toastText.innerHTML = html;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 2400);
    }

    function escapeHtml(s){
      if(!s) return '';
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }
  </script>
</body>
</html>
